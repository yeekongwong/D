# ES

---

## 1.定义
> Elasticsearch是一个开源的高扩展的分布式全文检索引擎，它可以近乎实时的存储、检索数据；本身扩展性很好，可以扩展到上百台服务器，处理PB级别的数据。(1PB=1024TB)

## 2.核查概念
> + 集群
    - 1.同个集群中节点之间可以扩容缩容；
    - 2.相同分片不会放在同一个节点上；
    - 3.朱分片的数量会在其索引创建完成修正，但副本分片数量也会随时变化
+ 节点
+ 分片
    - 1.es默认创建了5个主分片和一组从分片(5个从分片)。但默认情况下从分片没有启动，主要由于主从分片在同一个节点没有意义，此时的集群健康颜色为黄色。
    - 2.分片算法公式为：shard = hash(routing) % number_of_primary_shards。默认情况下routing值的是_id,也可以自定义。这也说明了为啥索引创建之后主分片个数不可以修改，如果改了则之前数据就无法查询到。
+ 副本容灾
    - 1.ES中的index，首先会进行分片，每一个分片数据一般都会有自己的副本数据，ES分配分片的策略会保证同一个分片数据和自己的副本不会分配到同一个节点上
	- 2.当集群中的某一节点宕机后，ES的master在ping该节点时通过一定的策略会发现该节点不存活；此时，ES开启恢复过程，恢复的策略如下：
        - 2.1.  恢复的目标是保证集群中分片的副本数不变
        - 2.2.  如果宕机的节点上承载某分片的主分片，那么此时（恢复过程）会将该分片分配在其他节点上的某一副本提升为主分片（记住：同一分片和其副本总是不在同一节点上，那么此事是保证有对应的副本可供提升的）
        - 2.3.  根据1保证副本数不变，如果宕机的节点承载某分片的副本，那么ES会在其他非宕机节点上用主分片复制一个副本
        - 2.4.  整个过程不影响集群的读写功能；但是由于多了复制分片和迁移分片的过程，集群的读写性能受影响 
        
## 3.倒排索引
> 问题引入：相对数据库的b+ tree 主要优势在什么地方？

> 先举个栗子:
| docId | 性别   |  年龄  |
| :----: | :----:  | :----:  |
| 1     | man |   18     |
| 2        |   woman   |   18   |
| 3        |    man    |  20  |
下面为数据表格,每一行就是一个文档，每个文档有一个文档id，而这些文档简历的倒排索引如下：
性别字段：
| term | posting list   |  
| :----: | :----:  | 
| 18     | 1,2 |  
| 20     |   3   |  
年龄字段：
| term | posting list   |  
| :----: | :----:  | 
| 女     | 2 |  
| 男     |   1,3  |  

> 主要是对针对每个字段做倒排索引的。postinglist对应文档的id，而term对应字段的值。

---
> 在es里面，主要的结构是
**Term Index -> Term Dictionary -> Posting List**
> term dictionary就是对term进行排序，从而在查找时可用二分查找，将复杂度弄为logN。然而，磁盘的随机读取操作还是很昂贵的，所以想尽量少的读磁盘，故有必要将数据缓存到内存里。但term dictionary的数据比较大，无法完整放到内存里面去。于是就有了term index的存在，就类似字典的章节表，可根据某个字符开头找到对应的term，然后再顺序找对应的文档数据。term index本身也是一棵tree树。这棵树不会包含所有的term，主要包含的是term的一些前缀。另外通过压缩技术，这个term index的大小估计只有原本的几十分之一，这样子就可以将term index缓存到内存中。
> 现在回到引入的问题：**mysql是只有term dictionary**这一层而已，是以b-tree结构存储在磁盘上的，在检索一个term时需要若干次的random access磁盘操作。而lucene是添加了term index缓存在内存中，从而加速检索。先从term index 找到对应的term dictionary的block位置之后再去找term，从而减少了磁盘的random access次数。
> 1.term index是以**FST的形式保存在内存**的，特点是节省内存;
  2.Term dictionary在磁盘上是以分block的方式保存的，一个block内部利用**公共前缀压缩**，比如都是Ab开头的单词就可以把Ab省去。这样term dictionary可以比b-tree更节约磁盘空间)

